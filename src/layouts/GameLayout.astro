---
import Header from '../components/Header.astro';

export interface Props {
  title: string;
  description: string;
  keywords?: string;
  lang?: string;
  canonicalUrl?: string;
  ogImage?: string;
  gameImage?: string;
  gameImageOpacity?: string;
  gameIframeUrl?: string;
  gameId?: string;
  customStyles?: string;
  customScripts?: string;
  gameContent?: string;
}

const {
  title,
  description,
  keywords,
  lang = 'en',
  canonicalUrl,
  ogImage,
  gameImage,
  gameImageOpacity = "0.5, 0.3",
  gameIframeUrl,
  gameId = 'fiddlebops-iframe',
  customStyles = '',
  customScripts = '',
  gameContent = ''
} = Astro.props;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Game",
  "name": title,
  "alternateName": "playfiddlebops.com",
  "url": canonicalUrl,
  "description": description
};

const defaultGameStyles = `
audio {width:210px}
.game-card .game-iframe-sprunki {
  float:left;
  width: 69%;
  margin:0;
  padding:0;
  height:600px;
  background-color:#fff;
  position: relative;
  ${gameImage ? `background-image: linear-gradient(rgba(255, 255, 255, ${gameImageOpacity})), url(${gameImage});` : ''}
  background-repeat: no-repeat;
  background-position: center center;
  background-size:cover;
}
.game .game-l-2 img {
  width: 100%!important;
  height:auto;
  margin: 0 auto;
}
@media screen and (max-width: 980px){
  .game-card .game-iframe-sprunki {
    width:100%;
  }
}
@media screen and (max-width: 768px){
  audio {width: 120px}
  .game-card .game-iframe-sprunki {
    height:330px!important;
  }
}
${customStyles}
`;

const defaultGameScripts = `
<script>
document.addEventListener('DOMContentLoaded', function() {
    let iframeLoaded = false;
    const gameIframeUrl = "${gameIframeUrl}";
    const gameId = "${gameId || 'fiddlebops-iframe'}";
    
    // 获取DOM元素并验证
    const iframe = document.getElementById(gameId);
    const playButton = document.getElementById("playButton");
    const gameImageContainer = document.querySelector(".game-iframe-sprunki");
    
    function loadIframe() {
        try {
            // 检查必要元素是否存在
            if (!iframe) {
                console.warn('游戏iframe未找到，gameId:', gameId);
                return;
            }
            
            if (!gameIframeUrl) {
                console.warn('游戏URL未设置');
                return;
            }
            
            // 加载游戏
            iframe.src = gameIframeUrl;
            iframeLoaded = true;
            iframe.focus();
            
            // 隐藏播放按钮
            if (playButton) {
                playButton.style.display = "none";
            }
            
            // 移除背景图片
            if (gameImageContainer) {
                gameImageContainer.style.backgroundImage = "none";
            }
            
        } catch (error) {
            console.error('加载游戏失败:', error);
        }
    }
    
    // 绑定播放按钮点击事件
    if (playButton) {
        playButton.addEventListener("click", loadIframe);
    } else {
        console.warn('播放按钮未找到');
        // 如果没有播放按钮，直接加载游戏
        if (iframe && gameIframeUrl) {
            setTimeout(loadIframe, 100);
        }
    }
});
</script>
${customScripts}
`;
---

<!DOCTYPE html>
<html lang={lang}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    {keywords && <meta name="keywords" content={keywords}>}
    <meta name="description" content={description}>
    <meta name="robots" content="index, follow"/>
    
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
    
    <meta property="og:title" content={title}/>
    <meta property="og:description" content={description}/>
    <meta property="og:url" content={canonicalUrl}/>
    <meta property="og:site_name" content="FiddleBops"/>
    <meta property="og:locale" content="en_US"/>
    <meta property="og:image" content={ogImage}/>
    <meta property="og:type" content="website"/>

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content={canonicalUrl}/>
    <meta name="twitter:title" content={title}/>
    <meta name="twitter:description" content={description}/>
    <meta name="twitter:image" content={ogImage}/>

    <link rel="icon" href="https://www.playfiddlebops.com/favicon.ico"/>
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/src/styles/global.css">
    <link rel="stylesheet" href="/src/styles/components.css">
    <link rel="stylesheet" href="/src/styles/modern-variables.css">
    <link rel="stylesheet" href="/src/styles/modern-game-cards.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style set:html={defaultGameStyles}></style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.querySelector('.nav-toggle');
      const navMenu = document.querySelector('.nav-menu');
    
      navToggle.addEventListener('click', function() {
        navMenu.classList.toggle('active');
      });

    });
    </script>

    <Fragment set:html={defaultGameScripts} />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9JME3P55QJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9JME3P55QJ');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1444054360166733" crossorigin="anonymous"></script>
    <meta name="google-adsense-account" content="ca-pub-1444054360166733">
</head>
<body>
    <Header />

    <main>
        <section class="hero">
            <div class="container">
                <div class="game-card">
                    <div class="game-info" id="paly">
                    </div>
                    <div class="game-iframe-sprunki">
                        <iframe 
                            id={gameId}
                            src=""
                            allowtransparency="true"
                            frameborder="0"
                            scrolling="no"
                            allowfullscreen
                            width="100%"
                            height="100%">
                        </iframe>
                        <button id="playButton">Play</button>
                    </div>
                </div>
            </div>
        </section>

        <slot />
    </main>

    <footer>
        <div class="container">
            <nav>
                <ul>
                    <li><a href="/privacy/">Privacy Policy</a></li>
                    <li><a href="/terms-of-service/">Terms of service</a></li>
                </ul>
            </nav>
            <p class="copyright" style="text-align: left;">© 2025 Fiddlebops. All rights reserved.</p>
            <p style="text-align: left;margin-top:0">E-mail: chongzhidatech@gmail.com</p>
        </div>
    </footer>

    <script>
      function goToLink(event) {
        const select = event.target;
        const selectedOption = select.options[select.selectedIndex];
        const url = selectedOption.getAttribute('data-url');
        if (url) {
          window.location.href = url;
        }
      }
  
      document.addEventListener('DOMContentLoaded', () => {
        const select = document.querySelector('select');
        if (select) {
          select.addEventListener('change', goToLink);
  
          const htmlLang = document.documentElement.lang;
          const options = Array.from(select.options);
  
          const currentOption = options.find(option =>
            option.getAttribute('data-lang') === htmlLang
          );
  
          if (currentOption) {
            currentOption.selected = true;
          } else {
            let defaultOption = options.find(option =>
              option.getAttribute('data-lang') === 'en'
            );
  
            if (!defaultOption) {
              defaultOption = options.find(option =>
                option.getAttribute('data-lang') === '/'
              );
            }
  
            if (defaultOption) {
              defaultOption.selected = true;
            }
          }
        }
      });
    </script>

    <!-- AddToAny Social Share -->
    <style>
    @media screen and (max-width: 980px) {
        .a2a_floating_style.a2a_vertical_style { display: none; }
    }
    @media screen and (min-width: 980px) {
        .a2a_floating_style.a2a_default_style { display: none; }
    }
    </style>
    <div class="a2a_kit a2a_kit_size_32 a2a_floating_style a2a_default_style" data-a2a-scroll-show="0,60" style="bottom:0px; right:0px;">
        <a class="a2a_button_x"></a>
        <a class="a2a_button_reddit"></a>
        <a class="a2a_button_facebook"></a>
        <a class="a2a_button_telegram"></a>
        <a class="a2a_button_whatsapp"></a>
        <a class="a2a_button_linkedin"></a>
        <a class="a2a_dd" href="https://www.playfiddlebops.com/"></a>
    </div>
    <div class="a2a_kit a2a_kit_size_32 a2a_floating_style a2a_vertical_style" style="left:0px; top:150px;">
        <a class="a2a_button_x"></a>
        <a class="a2a_button_reddit"></a>
        <a class="a2a_button_facebook"></a>
        <a class="a2a_button_telegram"></a>
        <a class="a2a_button_whatsapp"></a>
        <a class="a2a_button_linkedin"></a>
        <a class="a2a_dd" href="https://www.playfiddlebops.com/"></a>
    </div>
    <script defer src="https://static.addtoany.com/menu/page.js"></script>
</body>
</html>